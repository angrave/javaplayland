// Generated by CoffeeScript 1.8.0
(function() {
  "use strict";
  var initializeDoppioEnvironment, load_mini_rt, onResize, root, saveFile,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  root = window.coderunner = {};

  load_mini_rt = function() {
    return node.fs.readFile("/sys/preload.tar", function(err, data) {
      var xhrfs;
      if (err) {
        console.error("Error downloading preload.tar: " + err);
        return;
      }
      xhrfs = node.fs.getRootFS().mntMap["/sys"];
      return untar(new util.BytesArray(data), (function(percent, path, file) {
        var e;
        if (path[0] !== '/') {
          path = "/" + path;
        }
        try {
          if (file.length > 0) {
            return xhrfs.preloadFile(path, file);
          }
        } catch (_error) {
          e = _error;
          return console.error("Error writing " + path + ": " + e);
        }
      }));
    });
  };

  saveFile = function(fname, contents) {
    if (contents[contents.length - 1] !== '\n') {
      contents += '\n';
    }
    return node.fs.writeFileSync(fname, contents);
  };

  initializeDoppioEnvironment = function() {
    if (root.doppioEnvironmentInitialized) {
      return;
    }
    root._bs_cl = new ClassLoader.BootstrapClassLoader(jvm.read_classfile);
    return root.doppioEnvironmentInitialized = true;
  };

  onResize = function() {
    return $('#source').height(Math.min(50, $(window).height() * 0.25));
  };

  window.CodeRunner = (function() {
    CodeRunner.prototype.stdout = null;

    CodeRunner.prototype.user_input = null;

    function CodeRunner() {
      this.run = __bind(this.run, this);
      this.edit = __bind(this.edit, this);
      var JavaMode;
      this.rs = null;
      this.runJavaBtn = $('#run_btn');
      this.stopJavaBtn = $('#abort_btn');
      this.outputDiv = $('#output');
      this.editor = ace.edit('source');
      this.session = this.editor.getSession();
      JavaMode = require("ace/mode/java").Mode;
      this.session.setMode(new JavaMode());
      this.session.setValue("for(int i=0;i<10;i++) {print(i);}\nclasses.doppio.JavaScript.eval(\"alert(1)\");");
      this.stopJavaBtn.attr("disabled", true);
      this.runJavaBtn.click((function(_this) {
        return function(e) {
          _this.run();
          return e.preventDefault();
        };
      })(this));
      onResize();
      return;
    }

    CodeRunner.prototype.edit = function() {
      this.editor.focus();
      return this;
    };

    CodeRunner.prototype.run = function() {
      var class_args, contents, finish_cb, fname, msg, stdin, stdout;
      this.outputDiv.text('Starting...3..');
      initializeDoppioEnvironment();
      this.outputDiv.text(this.outputDiv.text() + '2..');
      fname = "/tmp/program.bsh";
      contents = this.session.getValue();
      saveFile(fname, contents);
      msg = '';
      stdout = (function(_this) {
        return function(str) {
          msg += str;
          return _this.outputDiv.text(msg);
        };
      })(this);
      stdin = function() {
        return "\n";
      };
      class_args = [fname];
      finish_cb = (function(_this) {
        return function() {
          return _this.outputDiv.text('Done');
        };
      })(this);
      this.rs = null;
      this.rs = new runtime.RuntimeState(stdout, stdin, root._bs_cl);
      jvm.set_classpath('/sys/vendor/classes/', '/tmp/');
      this.outputDiv.text(this.outputDiv.text() + '1..');
      this.stopJavaBtn.click((function(_this) {
        return function(e) {
          var aborted_cb;
          if (_this.rs) {
            stdout('Stopping...');
            _this.stopJavaBtn.attr("disabled", true);
            aborted_cb = function() {
              _this.rs = null;
              stdout('Stopped');
              return _this.runJavaBtn.attr("disabled", false);
            };
            _this.rs.async_abort(aborted_cb);
            return e.preventDefault();
          }
        };
      })(this));
      this.runJavaBtn.attr("disabled", true);
      this.stopJavaBtn.attr("disabled", false);
      finish_cb = (function(_this) {
        return function() {
          _this.stopJavaBtn.attr("disabled", true);
          _this.runJavaBtn.attr("disabled", false);
          return _this.edit();
        };
      })(this);
      this.outputDiv.text('');
      jvm.run_class(this.rs, 'bsh/Interpreter', class_args, finish_cb);
      return this;
    };

    return CodeRunner;

  })();

  $(document).ready(function() {
    load_mini_rt();
    return new window.CodeRunner();
  });

}).call(this);
